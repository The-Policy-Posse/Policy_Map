<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capitol Compass US States and Congressional Districts</title>
    <script src="libs/d3.v7.min.js"></script>
    <script src="libs/d3-geo-projection.v2.min.js"></script>
    <script src="libs/d3-force.v3.min.js"></script>
    <script src="libs/membersProfile.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            box-sizing: border-box;
            
        }
        /* Container for the entire layout */
        .layout-container {
            display: flex;
            flex-direction: column;
            width: 80%;
            max-width: 1200px;
            height: 70vh;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            margin: auto;
        }
        /* header styling */
        header {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: #f5f5f5;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #ccc;
            margin-bottom: 0;
        }
        /* Header text alignment */
        .header-left {
            font-size: 28px;;
        }
        .header-right {
            font-size: 14px;
            text-align: right;
            color: #555;
            line-height: 1.4;
        }
        /* Middle container */
        .middle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f5f5f5;
            border-top: 1px solid #ccc;
            border-bottom: 2px solid #ccc;
        }
        /* Tabs styling */
        .tabs {
            display: flex;
            margin-right: 27%;
            transform: translateX(-27%);
            margin-top: 5px;
        }
        .tabs button {
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #e0e0e0;
            border-radius: 4px 4px 0 0;
            margin-right: 4px;
        }
        .tabs button.active {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        /* Tab container styling */
        .tab-container {
            flex-grow: 1;
            height: 100%;
            padding: 20px;
            background-color: #e0e0e0;
            color: #000;
            overflow-y: auto;
            box-sizing: border-box;
            margin: 0;
        }
        /* Container for map and sidebar */
        .main-container {
            display: flex;
            height: 100%;
            flex-grow: 1;
            overflow-y: auto;
        }
        /* Map container */
        #map-container {
            flex-basis: 50%;
            padding-left: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            height: 100%;
            border-right: 2px solid #ccc;
        
        }
        /* Map styling */
        #map {
            width: 100%;
            height: 100%;
        }
        /* Sidebar styling */
        #sidebar {
            flex-basis: 50%;
            height: 100%;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-color: #f8f8f8;
            overflow-y: auto;
        }
        /* Tooltip styling */
        .tooltip{
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            color: #000;
            padding: 8px 12px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 16px;
            font-weight: bold;
            visibility: hidden;
            z-index: 10;
        }
        /* State and district styling */
        .state {
            stroke: #fff;
            stroke-width: 0.7px;
        }
        .district {
            stroke: #000;
            stroke-width: 0.2px;
            display: none;
        }
        .state-label {
            font-size: 18px;
            font-weight: bold;
            fill: #444;
            pointer-events: none;
        }
       
       .member-profile {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            width: 100%;
        }
        .profile-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .member-info {
            line-height: 1.2;
        }
        .member-info strong {
            font-size: 14px;
            display: block;
            color: #333;
        }
        .member-info a {
            color: #0073e6;
            text-decoration: none;
        }
        .member-info a:hover {
            text-decoration: underline;
        }
        .button-container {
            display: flex;
            align-items: center;
        }
        /* Button styling */
        button {
            margin-right: 10px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #e0e0e0;
            color: #000;
            border-radius: 4px 4px 0 0;
            box-shadow: none;
        }
        
            
    </style>
</head>
<body>
    <div class="layout-container">
        <header>
            <div class="header-left">Capitol Compass</div>
            <div class="header-right">
                Welcome! Find information about your state and elected officials here!
                <br>Select a State from the Map, or click on one of the Tabs to get started.
            </div>
        </header>
        <!-- Top section with back button and tabs -->
        <div class="middle-container">
            <div class="button-container">
                <button id="backToNationalView" onclick="reset()" style="display: none;" aria-label="Back to National View">
                     <- Back to National View
                </button>
                <button id="backToStateView" onclick="backToStateView()" style="display: none;" aria-label="Back to State View">
                     <- Back to State View
                </button>
            </div>
            <div class="tabs">
                <button onclick="showTab('general')" class="active">General</button>
                <button onclick="showTab('network')">Network</button>
                <button onclick="showTab('ideology')">Ideology</button>
            </div>
        </div>
        <!-- Main container for map and sidebar -->
        <div class="main-container">
            <div id="map-container">
                <svg id="map"></svg>
            </div>
            <!-- Sidebar for displaying information -->
            <div id="sidebar">
                <!-- General tab container -->
                <div id="general-container" class="tab-container" style="display: block;">
                    <h2>General Information</h2>
                    <p>Select a State from the Map, or click on one of the Tabs to get started.</p>
                </div>

                <!-- Network tab container -->
                 <div id="network-container" class="tab-container" style="display: none;">
                    <h2>Network</h2>
                    <p>Network information will be displayed here.</p>
                </div>
                
                <!-- Ideology tab container -->
                <div id="ideology-container" class="tab-container" style="display: none;">
                    <h2>Ideology</h2>
                    <p>Ideology information will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set up SVG container dimensions
        // Set up zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on("zoom", zoomed);

        // Define global variables
        let stateBounds = null;
        let stateZoomLevel = null;
        let lastSelectedState = null;
        let lastSelectedStateFP = null;
        let currentViewLevel = "national";  // national, state, district

        // Global variables for map container dimensions
        let containerWidth = document.getElementById("map-container").clientWidth;
        let containerHeight = document.getElementById("map-container").clientHeight;

        // Create the map projection
        const projection = d3.geoAlbersUsa()
            .scale([Math.min(containerWidth, containerHeight) * 1.2])
            .translate([containerWidth / 2, containerHeight / 2]);

        // Generate paths for states and districts using the projection
        const path = d3.geoPath().projection(projection);

        // Create SVG container for the map
        const svg = d3.select("#map")
            .attr("preserveAspectRatio", "xMidYMid meet")
            .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
            .call(zoom);

        // Append group to hold map elements
        const g = svg.append("g");
        // Create <defs> for curved text paths
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip");

        // Load GeoJSON data
        Promise.all([
            // Fetch US States data
            fetch("http://localhost:5001/api/us_states")
                .then(response => response.json())
                .then(data => ({
                    type: "FeatureCollection",
                    features: data.states.map(state => ({
                        type: "Feature",
                        geometry: JSON.parse(state.geometry),
                        properties: {
                            NAME: state.name,
                            STUSPS: state.stusps,
                            STATEFP: state.statefp,
                            STATE_PARTY: state.party
                        },
                    })),
                })),

            // Fetch Congressional Districts data
            fetch("http://localhost:5001/api/congressional_districts")
                .then(response => response.json())
                .then(data => ({
                    type: "FeatureCollection",
                    features: data.districts.map(district => ({
                        type: "Feature",
                        geometry: JSON.parse(district.geometry),
                        properties: {
                            STATEFP20: district.statefp20,
                            CD118FP: district.cd118fp,
                            OFFICE_ID: district.office_id,
                            LISTING_NAME: district.listing_name,
                            WEBSITE_URL: district.website_url,
                            PARTY: district.party,
                            DISTRICT: district.district,
                            COMMITTEE_ASSIGNMENTS: district.committee_assignments,
                        },
                    })),
                })),
        ]).then(([states, districts]) => {
            initMap(states, districts);
        }).catch(error => {
            console.error("Error loading GeoJSON data:", error);
        });

        // Function to initialize the map
        function initMap(states, districts) {
            // Define colors for political parties
            const partyColors = {
                "R": "#ff4d4d",
                "D": "#4d79ff",
            };
            // Draw states
            const statePaths = g.selectAll(".state")
                .data(states.features)
                .enter().append("path")
                .attr("class", "state")
                .attr("d", path)
                .attr("fill", d => {
                    const party = d.properties.STATE_PARTY;
                    return partyColors[party] || "#ccc";
                })
                .attr("cursor", "pointer")
                .on("click", stateClicked)
                .on("mouseover", function(event, d) {
                    const baseColor = partyColors[d.properties.STATE_PARTY] || "#ccc";
                    d3.select(this).attr("fill", darkenColor(baseColor, -50));
                    tooltip.style("visibility", "visible")
                        .text(d.properties.NAME);
                })
                .on("mousemove", function(event) {
                    tooltip.style("top", (event.pageY - 10) + "px")
                        .style("left", (event.pageX + 10) + "px");
                })
                .on("mouseout", function(event, d) {
                    const originalColor = partyColors[d.properties.STATE_PARTY] || "#ccc";
                    d3.select(this).attr("fill", originalColor);
                    tooltip.style("visibility", "hidden");
                });
          
            // Draw districts
            const districtPaths = g.selectAll(".district")
                .data(districts.features)
                .enter().append("path")
                .attr("class", "district")
                .attr("d", path)
                .style("fill", d => {
                    const party = d.properties.PARTY;
                    const baseColor = partyColors[party] || "#ccc";
                    return darkenColor(baseColor, -50);
                })
                .style("display", "none")
                .attr("cursor", "pointer")
                .on("click", function(event, d) {
                    event.stopPropagation();
                    console.log("District Clicked:", d.properties.NAME);
                    districtClicked(event, d, d.properties.NAME);
                })
                .on("mouseover", function() {
                    d3.select(this).attr("fill", "#2c7fb8");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("fill", "#69b3a2");
                });
        }

       // Function to zoom in to a state view
        function stateClicked(event, d) {
            // Update the current view level and selected state information
            currentViewLevel = "state";
            lastSelectedState = d.properties.NAME;
            lastSelectedStateFP = d.properties.STATEFP;

            // Calculate bounding box of the clicked state
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            stateBounds = [[x0, y0], [x1, y1]];
            stateZoomLevel = Math.min(7, 0.6 / Math.min((x1 - x0) / containerWidth, (y1 - y0) / containerHeight));

            // Zoom into the clicked state
            event.stopPropagation();
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(Math.min(7, 0.6 / Math.min((x1 - x0) / containerWidth, (y1 - y0) / containerHeight)))
                    .translate(-(x0 + x1) / 2, -(y0 + y1) / 2),
                d3.pointer(event, svg.node())
            );

            // Show the "Back to National View" button
            document.getElementById("backToNationalView").style.display = "block";
            document.getElementById("backToStateView").style.display = "none";

            // Show state senators in the sidebar
            const generalContent = showModalForState(lastSelectedState);
            document.getElementById("general-container").innerHTML = generalContent;

            // Show network info for state
            const networkContent = generateNetworkInfo(lastSelectedState);
            document.getElementById("network-container").innerHTML = networkContent;

            // Show ideology info for state
            const ideologyContent = generateIdeologyInfo(lastSelectedState);
            document.getElementById("ideology-container").innerHTML = ideologyContent;

            //  Display districts for the selected state
            g.selectAll(".district")
                .style("display", district => district.properties.STATEFP20 === lastSelectedStateFP ? "block" : "none")
                .each(function(districtData) {
                    d3.select(this)
                        .on("click", function(event) {
                            districtClicked(event, districtData, lastSelectedState);
                        })
                        .on("mouseover", function() {
                            d3.select(this).attr("fill", "#2c7fb8");
                            const officeID = districtData.properties.OFFICE_ID;
                            const stateAbbr = officeID.slice(0, 2);
                            const repName = districtData.properties.LISTING_NAME;
                            const districtNumber = officeID.slice(2);
                            tooltip.style("visibility", "visible")
                                .html(`Rep. ${repName}<br>${stateAbbr}-${districtNumber}`);
                        })
                        .on("mousemove", function(event) {
                            tooltip.style("top", (event.pageY - 10) + "px")
                                .style("left", (event.pageX + 10) + "px");
                        })
                        .on("mouseout", function() {
                            const partyColors = {
                                "R": "#ff4d4d",
                                "D": "#4d79ff",
                            };
                            const party = districtData.properties.PARTY;
                            const originalColor = partyColors[party] || "#ccc";
                            d3.select(this).attr("fill", originalColor);
                            tooltip.style("visibility", "hidden");
                        });
                });
                // Show the "General" tab by default
                showTab('general');
        }

        // Function to darken the party color
        function darkenColor(hex, amount) {
            // Ensure the color is in hex format
            if (!/^#/.test(hex)) return hex;
            // Darken the color
            return "#" + hex.replace(/^#/, '').replace(/../g, color => 
                ('0' + Math.max(0, Math.min(255, parseInt(color, 16) + amount)).toString(16)).slice(-2)
            );
        }

        // Function to filter members by district
        function districtClicked(event, d, stateName) {
            console.log("District Clicked:", d.properties.DISTRICT);
            console.log("State Name:", stateName);

            // Track district level data
            currentViewLevel = "district";
            lastSelectedState = stateName;
            const districtNumber = d.properties.DISTRICT;
            lastSelectedDistrict = districtNumber;
            
            // Update "General" tab
            const generalContent = showModalForState(lastSelectedState, lastSelectedDistrict);
            document.getElementById("general-container").innerHTML = generalContent;

            // Update "Network" tab
            const networkContent = generateNetworkInfo(lastSelectedState);
            document.getElementById("network-container").innerHTML = networkContent;

            // Update "Ideology" tab
            const ideologyContent = generateIdeologyInfo(lastSelectedState);
            document.getElementById("ideology-container").innerHTML = ideologyContent;

            // Calculate bounding box of the clicked district
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            // Transition to the district view
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(Math.min(18, 0.6 / Math.min((x1 - x0) / containerWidth, (y1 - y0) / containerHeight)))
                    .translate(-(x0 + x1) / 2, -(y0 + y1) / 2),
                d3.pointer(event, svg.node())
            );

            // Darken the district color
            const districtElement = d3.select(event.target);
            const baseColor = districtElement.attr("fill") || "#ccc";
            const darkerColor = darkenColor(baseColor, -40);
            districtElement.attr("fill", darkerColor);

            // Update button visibility
            document.getElementById("backToNationalView").style.display = "none";
            document.getElementById("backToStateView").style.display = "block";
            // Show general tab by default and update tab content
            showTab('general');
        }

        // Function to handle zoom transformation
        function zoomed(event) {
            const {transform} = event;
            g.attr("transform", transform);
            g.attr("stroke-width", 1 / transform.k);
        }

        // Function to reset zoom
        function reset() {
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity,
            );
            // Hide all districts
            g.selectAll(".district")
                .style("display", "none");
            // Clear member profiles when zooming out
            resetTabs();
            // Hide the "Back to National View" button
            document.getElementById("backToNationalView").style.display = "none";
            // Hide the "Back to State View" button
            document.getElementById("backToStateView").style.display = "none";
        }

        // Function to go back to state view
        function backToStateView() {
            // Reset the view level to "state"
            currentViewLevel = "state";

            // Reset the zoom level to the state bounds
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(stateZoomLevel)
                    .translate(-(stateBounds[0][0] + stateBounds[1][0]) / 2, -(stateBounds[0][1] + stateBounds[1][1]) / 2),
                d3.pointer(event, svg.node())
            );
            // Show districts again
            g.selectAll(".district")
                .style("display", district => district.properties.STATEFP20 === lastSelectedStateFP ? "block" : "none");

            // Update tabs to reflect state-level data
            const generalContent = showModalForState(lastSelectedState);
            document.getElementById("general-container").innerHTML = generalContent;

            const networkContent = generateNetworkInfo(lastSelectedState);
            document.getElementById("network-container").innerHTML = networkContent;

            const ideologyContent = generateIdeologyInfo(lastSelectedState);
            document.getElementById("ideology-container").innerHTML = ideologyContent;
            
            // Show the "General" tab by default
            showTab('general');

            // Update button visibility
            document.getElementById("backToNationalView").style.display = "block";
            document.getElementById("backToStateView").style.display = "none";
        }

        // Function to show tab content
        function showTab(tabID) {
            // Hide all tab containers
            document.querySelectorAll('.tab-container').forEach(tab => {
                tab.style.display = 'none';
            });

            // Show the selected tab content based on the current view level
            const tabContainer = document.getElementById(`${tabID}-container`);
            if (tabContainer) {
                tabContainer.style.display = 'block';

                // Dynamically update content based on the current view level
                if (currentViewLevel === "state" && lastSelectedState) {
                    switch (tabID) {
                        case 'general':
                            tabContainer.innerHTML = `
                                <h2>${lastSelectedState} - General Information</h2>
                                <p>Here are the Senators and general information for ${lastSelectedState}.</p>
                                ${showModalForState(lastSelectedState)}`;
                            break;

                        case 'network':
                            tabContainer.innerHTML = `
                                <h2>${lastSelectedState} - Network Information</h2>
                                <p>Explore the network of congressional districts in ${lastSelectedState}.</p>
                                ${generateNetworkInfo(lastSelectedState)}`;
                            break;

                        case 'ideology':
                            tabContainer.innerHTML = `
                                <h2>${lastSelectedState} - Ideology Information</h2>
                                <p>Explore the ideology distribution of elected officials in ${lastSelectedState}.</p>
                                ${generateIdeologyInfo(lastSelectedState)}`;
                            break;

                        default:
                            console.error(`Tab with ID '${tabID}' not found.`);
                    }
                } else if (currentViewLevel === "district" && lastSelectedState && lastSelectedDistrict) {
                    switch (tabID) {
                        case 'general':
                            tabContainer.innerHTML = `
                                <h2>${lastSelectedState} - District ${lastSelectedDistrict} Information</h2>
                                <p>Here are the elected officials and general information for District ${lastSelectedDistrict}.</p>
                                ${showModalForState(lastSelectedState, lastSelectedDistrict)}`;
                            break;
                        case 'network':
                            tabContainer.innerHTML = `
                                <h2>${lastSelectedState} - District ${lastSelectedDistrict} Network Information</h2>
                                <p>Explore the network of elected officials in District ${lastSelectedDistrict}.</p>
                                ${generateNetworkInfo(lastSelectedState)}`;
                            break;
                        case 'ideology':
                            tabContainer.innerHTML = `
                                <h2>${lastSelectedState} - District ${lastSelectedDistrict} Ideology Information</h2>
                                <p>Explore the ideology distribution of elected officials in District ${lastSelectedDistrict}.</p>
                                ${generateIdeologyInfo(lastSelectedState)}`;
                            break;

                        default:
                            console.error(`Tab with ID '${tabID}' not found.`);
                    }
                } else {
                    // Default content for when no state or district is selected
                    tabContainer.innerHTML = `
                        <h2>${tabID.charAt(0).toUpperCase() + tabID.slice(1)} Information</h2>
                        <p>Select a State from the Map, or click on one of the Tabs to get started.</p>`;
                }
            } else {
                console.error(`Tab container with ID '${tabID}-container' not found.`);
            }

            // Update the active tab button
            document.querySelectorAll('.tabs button').forEach(button => {
                button.classList.remove('active'); // Remove active class from all buttons
            });

            const activeButton = document.querySelector(`.tabs button[onclick="showTab('${tabID}')"]`);
            if (activeButton) {
                activeButton.classList.add('active'); // Add active class to the selected button
            } else {
                console.error(`Tab button for '${tabID}' not found.`);
            }
        }

        // Function to get network information
        function generateNetworkInfo(stateName) {
            // Mock network information
            return `<p>Network information for ${stateName} will be displayed here.</p>`;
        }

        // Function to get ideology information
        function generateIdeologyInfo(stateName) {
            // Mock ideology information
            return `<p>Ideology information for ${stateName} will be displayed here.</p>`;
        }

        // Function to reset tabs
        function resetTabs() {
            // Reset the current view level to "national"
            currentViewLevel = "national";
            lastSelectedState = null; // Clear the last selected state
            lastSelectedStateFP = null; // Clear the last selected state code
            
            // Reset General tab content
            document.getElementById("general-container").innerHTML = `
                <h2>General Information</h2>
                <p>Select a State from the Map, or click on one of the Tabs to get started.</p>
            `;

            // Reset Network tab content
            document.getElementById("network-container").innerHTML = `
                <h2>Network</h2>
                <p>Network information will be displayed here.</p>
            `;

            // Reset Ideology tab content
            document.getElementById("ideology-container").innerHTML = `
                <h2>Ideology</h2>
                <p>Ideology information will be displayed here.</p>
            `;

            // Show the "General" tab by default
            showTab('general');

            // Hide the "Back to National View" and "Back to State View" buttons
            document.getElementById("backToNationalView").style.display = "none";
            document.getElementById("backToStateView").style.display = "none";
        }
    </script>
</body>
</html>