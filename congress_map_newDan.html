<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capitol Compass US States and Congressional Districts</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="libs/d3.v7.min.js"></script>
    <script src="libs/d3-geo-projection.v2.min.js"></script>
    <script src="libs/d3-force.v3.min.js"></script>
    <script src="js/membersProfile.js"></script>

    <script src="js/radarChart.js"></script>
</head>
<body>
    <div class="layout-container">
        <header>
            <div class="header-left">Capitol Compass</div>
            <div class="header-right">
                Welcome! Find information about your state and elected officials here!
                <br>Select a State from the Map, or click on one of the Tabs to get started.
            </div>
        </header>
        <!-- Top section with back button and tabs -->
        <div class="middle-container">
            <div class="button-container">
                <button id="backToNationalView" onclick="resetView()" style="display: none;" aria-label="Back to National View">
                     <- Back to National View
                </button>
                <button id="backToStateView" onclick="backToStateView()" style="display: none;" aria-label="Back to State View">
                     <- Back to State View
                </button>
            </div>
            <div class="tabs">
                <button onclick="showTab('general')" class="active">General</button>
                <button onclick="showTab('network')">Network</button>
                <button onclick="showTab('ideology')">Ideology</button>
            </div>
        </div>
        <!-- Main container for map and sidebar -->
        <div class="main-container">
            <div id="map-container">
                <svg id="map"></svg>
            </div>
            <!-- Sidebar for displaying information -->
            <div id="sidebar">
                <!-- General tab container -->
                <div id="general-container" class="tab-container" style="display: block;">
                    <h2>General Information</h2>
                    <p>Select a State from the Map, or click on one of the Tabs to get started.</p>
                </div>


                <!-- Network tab container -->
                <div id="network-container" class="tab-container" style="display: none;">
                    <div class="title-container">
                        <h2>Congress Members Radar Chart</h2>
                    </div>

                    <div id="controls">
                        <div class="toggle-controls">
                            <label>
                                <input type="radio" name="proportion-toggle" value="self" checked>
                                Self Proportion
                            </label>
                            <label>
                                <input type="radio" name="proportion-toggle" value="across_all">
                                Across All Proportion
                            </label>
                        </div>
                        <label for="member-select">Select Member: </label>
                        <select id="member-select"></select>
                    </div>

                    <div id="member-details"></div>

                    <div class="radarChart"></div>

                    <!-- Legend Container -->
                    <div id="legend-container" style="text-align: center; margin-top: 10px;">
                        <svg width="200" height="50"></svg>
                    </div>
                </div>
                
                <!-- Ideology tab container -->
                <div id="ideology-container" class="tab-container" style="display: none;">
                    <div class="chart-container">
                        <h2 class="chart-title">Ideology Distribution by State</h2>
                        <div class="controls">
                            <label for="topic-select">Select Topic: </label>
                            <select id="topic-select">
                                <option value="">--Select a Topic--</option>
                            </select>
                        </div>
                        <svg id="ideology-bar-chart"></svg>
                    </div>
                    <!-- Tooltip Div -->
                    <div class="tooltip"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set up SVG container dimensions
        // Set up zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on("zoom", zoomed);

        // Tooltip setup
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip-1");

        // Define global variables
        let stateBounds = null;
        let stateZoomLevel = null;
        let lastSelectedState = null;
        let lastSelectedStateFP = null;
        let currentViewLevel = "national";  // national, state, district

        // Global variables for map container dimensions
        let containerWidth = document.getElementById("map-container").clientWidth;
        let containerHeight = document.getElementById("map-container").clientHeight;

        // Create the map projection
        const projection = d3.geoAlbersUsa()
            .scale([Math.min(containerWidth, containerHeight) * 1.2])
            .translate([containerWidth / 2, containerHeight / 2]);

        // Generate paths for states and districts using the projection
        const path = d3.geoPath().projection(projection);

        // Create SVG container for the map
        const svg = d3.select("#map")
            .attr("preserveAspectRatio", "xMidYMid meet")
            .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
            .call(zoom);

        // Append group to hold map elements
        const g = svg.append("g");

        // Function to update dimensions and re-project paths
        function updateDimensions() {
            containerWidth = document.getElementById("map-container").clientWidth;
            containerHeight = document.getElementById("map-container").clientHeight;
            projection
                .scale([Math.min(containerWidth, containerHeight) * 1.2])
                .translate([containerWidth / 2, containerHeight / 2]);
            svg.attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`);
            g.selectAll("path").attr("d", path);
        }

        // Initialize dimensions
        updateDimensions();

        // Handle window resizing
        window.addEventListener("resize", updateDimensions);

        // Load GeoJSON data
        Promise.all([
            // Fetch US States data
            fetch("https://backend-server-304538040372.us-central1.run.app/api/us_states")
                .then(response => response.json())
                .then(data => ({
                    type: "FeatureCollection",
                    features: data.states.map(state => ({
                        type: "Feature",
                        geometry: JSON.parse(state.geometry),
                        properties: {
                            NAME: state.name,
                            STUSPS: state.stusps,
                            STATEFP: state.statefp,
                            STATE_PARTY: state.state_party
                        },
                    })),
                })),

            // Fetch Congressional Districts data
            fetch("https://backend-server-304538040372.us-central1.run.app/api/congressional_districts")
                .then(response => response.json())
                .then(data => ({
                    type: "FeatureCollection",
                    features: data.districts.map(district => ({
                        type: "Feature",
                        geometry: JSON.parse(district.geometry),
                        properties: {
                            STATEFP20: district.statefp20,
                            CD118FP: district.cd118fp,
                            OFFICE_ID: district.office_id,
                            LISTING_NAME: district.listing_name,
                            WEBSITE_URL: district.website_url,
                            PARTY: district.party,
                            DISTRICT: district.district,
                            COMMITTEE_ASSIGNMENTS: district.committee_assignments,
                        },
                    })),
                })),
        ]).then(([states, districts]) => {
            console.log("States data:", states);
            initMap(states, districts);
        }).catch(error => {
            console.error("Error loading GeoJSON data:", error);
        });

        // Function to initialize the map
        function initMap(states, districts) {
            // Define colors for political parties
            const partyColors = {
                "R": "#ff4d4d",
                "D": "#4d79ff",
            };

            // Draw states
            const statePaths = g.selectAll(".state")
                .data(states.features)
                .enter().append("path")
                .attr("class", "state")
                .attr("d", path)
                .attr("fill", d => {
                    const party = d.properties.STATE_PARTY;
                    return partyColors[party] || "#ccc";
                })
                .attr("cursor", "pointer")
                .on("click", stateClicked)
                .on("mouseover", function(event, d) {
                    const baseColor = partyColors[d.properties.STATE_PARTY] || "#ccc";
                    d3.select(this).attr("fill", darkenColor(baseColor, -30));
                    tooltip.style("visibility", "visible")
                        .text(d.properties.NAME);
                })
                .on("mousemove", function(event) {
                    tooltip.style("top", (event.pageY - 10) + "px")
                        .style("left", (event.pageX + 10) + "px");
                })
                .on("mouseout", function(event, d) {
                    const originalColor = partyColors[d.properties.STATE_PARTY] || "#ccc";
                    d3.select(this).attr("fill", originalColor);
                    tooltip.style("visibility", "hidden");
                });
          
            // Draw districts
            const districtPaths = g.selectAll(".district")
                .data(districts.features)
                .enter().append("path")
                .attr("class", "district")
                .attr("d", path)
                .style("fill", d => {
                    const party = d.properties.PARTY;
                    const baseColor = partyColors[party] || "#ccc";
                    return darkenColor(baseColor, -30);
                })
                .style("display", "none")
                .attr("cursor", "pointer")
                .on("click", function(event, d) {
                    event.stopPropagation();
                    console.log("District Clicked:", d.properties.NAME);
                    districtClicked(event, d, d.properties.NAME);
                })
                .on("mouseover", function(event, d) {
                    const baseColor = d3.select(this).style("fill");
                    const hoverColor = darkenColor(baseColor, -50);
                    d3.select(this).attr("fill", hoverColor);
                })
                .on("mouseout", function(event, d) {
                    const originalColor = d3.select(this).style("fill");
                    d3.select(this).attr("fill", originalColor);
                });
        }

       // Function to zoom in to a state view
        function stateClicked(event, d) {
            // Update the current view level and selected state information
            currentViewLevel = "state";
            lastSelectedState = d.properties.NAME;
            lastSelectedStateFP = d.properties.STATEFP;

            // Calculate bounding box of the clicked state
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            stateBounds = [[x0, y0], [x1, y1]];
            stateZoomLevel = Math.min(7, 0.6 / Math.min((x1 - x0) / containerWidth, (y1 - y0) / containerHeight));

            // Zoom into the clicked state
            event.stopPropagation();
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(Math.min(7, 0.6 / Math.min((x1 - x0) / containerWidth, (y1 - y0) / containerHeight)))
                    .translate(-(x0 + x1) / 2, -(y0 + y1) / 2),
                d3.pointer(event, svg.node())
            );

            updateButtonVisibility(true, false);
            updateTabContent(lastSelectedState);

            //  Display districts for the selected state
            g.selectAll(".district")
                .style("display", district => district.properties.STATEFP20 === lastSelectedStateFP ? "block" : "none")
                .each(function(districtData) {
                    d3.select(this)
                        .on("click", function(event) {
                            districtClicked(event, districtData, lastSelectedState);
                        })
                        .on("mouseover", function(event, districtData) {
                            const officeID = districtData.properties.OFFICE_ID;
                            const repName = districtData.properties.LISTING_NAME;
                            const stateAbbr = officeID.slice(0, 2);
                            const districtNumber = officeID.slice(2);
                            tooltip.style("visibility", "visible")
                                .html(`Rep. ${repName}<br>${stateAbbr}-${districtNumber}`);
                        })
                        .on("mousemove", function(event) {
                            tooltip.style("top", (event.pageY - 10) + "px")
                                .style("left", (event.pageX + 10) + "px");
                        })
                        .on("mouseout", function(event, districtData) {
                            const partyColors = {"R": "#ff4d4d", "D": "#4d79ff"};
                            const party = districtData.properties.PARTY;
                            const originalColor = partyColors[party] || "#ccc";
                            d3.select(this).attr("fill", originalColor);
                            tooltip.style("visibility", "hidden");
                        });
                });
                // Show the "General" tab by default
                showTab('general');
        }

        // Function to darken the party color
        function darkenColor(hex, amount) {
            // Ensure the color is in hex format
            if (!/^#/.test(hex)) return hex;
            // Darken the color
            return "#" + hex.replace(/^#/, '').replace(/../g, color => 
                ('0' + Math.max(0, Math.min(255, parseInt(color, 16) + amount)).toString(16)).slice(-2)
            );
        }

        // Function to filter members by district
        function districtClicked(event, d, stateName) {
            console.log("District Clicked:", d.properties.DISTRICT);
            console.log("State Name:", stateName);

            // Track district level data
            currentViewLevel = "district";
            lastSelectedState = stateName;
            const districtNumber = d.properties.DISTRICT;
            lastSelectedDistrict = districtNumber;
            
            updateTabContent(lastSelectedState, lastSelectedDistrict);

            // Calculate bounding box of the clicked district
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            // Transition to the district view
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(Math.min(18, 0.6 / Math.min((x1 - x0) / containerWidth, (y1 - y0) / containerHeight)))
                    .translate(-(x0 + x1) / 2, -(y0 + y1) / 2),
                d3.pointer(event, svg.node())
            );

            // Update button visibility
            updateButtonVisibility(false, true);
            showTab('general');

////////////////////////////////////////////////////////////// New Section ///////////////////////////////////////////
            // Assuming d.properties.LISTING_NAME contains the member's full name
            console.log("Name:", d.properties.LISTING_NAME);
            const memberName = d.properties.LISTING_NAME;
            console.log("Member Name:", memberName);

            // Find the member in the congressMembersData
            const member = window.congressMembersData.find(m => m.name === memberName);
            console.log("Found Mmber:", member);

            if (member) {
                // Store the currently selected member's bioguide_id globally
                window.currentSelectedBioguideId = member.bioguide_id;

                // Update the radar chart with the selected member
                window.updateRadarChart(member.bioguide_id);

                // Switch to the 'network' tab to display the radar chart
                showTab('network');
            } else {
                console.error(`Member with name "${memberName}" not found in data.`);
            }
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        }

        // Function to handle zoom transformation
        function zoomed(event) {
            const {transform} = event;
            g.attr("transform", transform);
            g.attr("stroke-width", 1 / transform.k);
        }

        // Function to reset zoom
        function resetView() {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            g.selectAll(".district").style("display", "none");
            resetTabs();
            updateButtonVisibility(false, false);
        }

        // Function to go back to state view
        function backToStateView() {
            // Reset the view level to "state"
            currentViewLevel = "state";

            // Reset the zoom level to the state bounds
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(stateZoomLevel)
                    .translate(-(stateBounds[0][0] + stateBounds[1][0]) / 2, -(stateBounds[0][1] + stateBounds[1][1]) / 2),
                d3.pointer(event, svg.node())
            );
            // Show districts again
            g.selectAll(".district")
                .style("display", district => district.properties.STATEFP20 === lastSelectedStateFP ? "block" : "none");

            // Update tabs to reflect state-level data
            updateTabContent(lastSelectedState);
            showTab('general');
            updateButtonVisibility(true, false);
        }

        // Function to show tab content
        function showTab(tabID) {
            // Hide all tab containers
            document.querySelectorAll('.tab-container').forEach(tab => {
                tab.style.display = 'none';
            });

            // Show the selected tab content based on the current view level
            const tabContainer = document.getElementById(`${tabID}-container`);
            if (tabContainer) {
                tabContainer.style.display = 'block';

                // Dynamically update content based on the current view level
                if (tabID === 'network') {
                    setTimeout(() => initializeNetworkChart(), 0);
                } else if (tabID === 'ideology') {
                    setTimeout(() => initializeIdeologyChart(), 0);
                } else if (currentViewLevel === 'state' && lastSelectedState) {
                    tabContainer.innerHTML = generateTabContent(tabID, lastSelectedState);
                } else if (currentViewLevel === 'district' && lastSelectedState && lastSelectedDistrict) {
                    tabContainer.innerHTML = generateTabContent(tabID, lastSelectedState, lastSelectedDistrict);
                } else {
                    // Default content for when no state or district is selected
                    tabContainer.innerHTML = `
                        <h2>${tabID.charAt(0).toUpperCase() + tabID.slice(1)} Information</h2>
                        <p>Select a State from the Map, or click on one of the Tabs to get started.</p>`;
                }
            } else {
                console.error(`Tab container with ID '${tabID}-container' not found.`);
            }

            // Update the active tab button
            document.querySelectorAll('.tabs button').forEach(button => {
                button.classList.remove('active'); // Remove active class from all buttons
            });

            const activeButton = document.querySelector(`.tabs button[onclick="showTab('${tabID}')"]`);
            if (activeButton) {
                activeButton.classList.add('active'); // Add active class to the selected button
            } else {
                console.error(`Tab button for '${tabID}' not found.`);
            }
        }

        function generateTabContent(tabID, state, district = null) {
            let content = '';
            switch (tabID) {
                case 'general':
                    content = `
                        <h2>${state} - ${district ? `District ${district}` : 'General'} Information</h2>
                        <p>Here are the ${district ? 'elected officials and general information for District ' + district : 'Senators and general information for ' + state}.</p>
                        ${showModalForState(state, district)}
                    `;
                    break;
                case 'network':
                    setTimeout(() => initializeNetworkChart(), 0);
                    break;
                case 'ideology':
                    setTimeout(() => initializeIdeologyChart(), 0);
                    break;
                default: 
                    console.error(`Tab with ID '${tabID}' not found.`);
            }
            return content;
        }

        // Function to reset tabs
        function resetTabs() {
            // Reset the current view level to "national"
            currentViewLevel = "national";
            lastSelectedState = null; // Clear the last selected state
            lastSelectedStateFP = null; // Clear the last selected state code
            
            // Reset General tab content
            document.getElementById("general-container").innerHTML = `
                <h2>General Information</h2>
                <p>Select a State from the Map, or click on one of the Tabs to get started.</p>
            `;

            // Reset Network tab content
            setTimeout(() => initializeNetworkChart(), 0);

            // Reset Ideology tab content
            setTimeout(() => initializeIdeologyChart(), 0);

            // Show the "General" tab by default
            showTab('general');
            updateButtonVisibility(false, false);
        }

        function updateTabContent(state, district = null) {
            document.getElementById("general-container").innerHTML = showModalForState(state, district);
            setTimeout(addEventListersForMembers, 0);
            setTimeout(() => initializeIdeologyChart(), 0);
            setTimeout(() => initializeNetworkChart(), 0);
        }

        function updateButtonVisibility(showBackToNational, showBackToState) {
            document.getElementById("backToNationalView").style.display = showBackToNational ? "block" : "none";
            document.getElementById("backToStateView").style.display = showBackToState ? "block" : "none"; 
        }

        function addEventListersForMembers() {
            const memberNames = document.querySelectorAll('.member-profile');
            memberNames.forEach(nameElement => {
                nameElement.addEventListener("click", function() {
                    const memberName = this.getAttribute('data-name-id');
                    const member = window.congressMembersData.find(m => m.name === memberName);
                    if (member) {
                        window.currentSelectedBioguideId = member.bioguide_id;
                        window.updateRadarChart(member.bioguide_id);
                        showTab('network');
                    }
                });
            });
        }

        ///////////////////////////////////////////////////////////
        ///////// Dan Test Charts /////////////////////
        ///////////////////////////////////////////////////////////


        // Global variable to store congress members data
        window.congressMembersData = [];


        // Function to initialize the D3 chart in the Network tab
        function initializeNetworkChart() {
            // Check if the chart has already been initialized to avoid re-initializing
            if (!initializeNetworkChart.initialized) {
                initializeNetworkChart.initialized = true; // Set a flag to prevent re-initialization

        // Define chamber-specific scaling factors
        const SCALING_FACTORS = {
                'Senate': 2,                      // No scaling for Senate
                'House of Representatives': 5     // Scaling factor for House (adjust as needed)
            };

            // Define the policy areas with exact column names
            const policyAreas = [
                {
                    display: "Agriculture and Food",
                    member_self: "Agriculture_and_Food_self_proportion",
                    member_across_all: "Agriculture_and_Food_across_all_proportion",
                    state_self: "Agriculture_And_Food_state_self_proportion",
                    state_national: "Agriculture_And_Food_state_national_proportion"
                },
                {
                    display: "Crime and Law Enforcement",
                    member_self: "Crime_and_Law_Enforcement_self_proportion",
                    member_across_all: "Crime_and_Law_Enforcement_across_all_proportion",
                    state_self: "Crime_And_Law_Enforcement_state_self_proportion",
                    state_national: "Crime_And_Law_Enforcement_state_national_proportion"
                },
                {
                    display: "Culture and Recreation",
                    member_self: "Culture_and_Recreation_self_proportion",
                    member_across_all: "Culture_and_Recreation_across_all_proportion",
                    state_self: "Culture_And_Recreation_state_self_proportion",
                    state_national: "Culture_And_Recreation_state_national_proportion"
                },
                {
                    display: "Economy and Finance",
                    member_self: "Economy_and_Finance_self_proportion",
                    member_across_all: "Economy_and_Finance_across_all_proportion",
                    state_self: "Economy_And_Finance_state_self_proportion",
                    state_national: "Economy_And_Finance_state_national_proportion"
                },
                {
                    display: "Education and Social Services",
                    member_self: "Education_and_Social_Services_self_proportion",
                    member_across_all: "Education_and_Social_Services_across_all_proportion",
                    state_self: "Education_And_Social_Services_state_self_proportion",
                    state_national: "Education_And_Social_Services_state_national_proportion"
                },
                {
                    display: "Environment and Natural Resources",
                    member_self: "Environment_and_Natural_Resources_self_proportion",
                    member_across_all: "Environment_and_Natural_Resources_across_all_proportion",
                    state_self: "Environment_And_Natural_Resources_state_self_proportion",
                    state_national: "Environment_And_Natural_Resources_state_national_proportion"
                },
                {
                    display: "Government Operations and Politics",
                    member_self: "Government_Operations_and_Politics_self_proportion",
                    member_across_all: "Government_Operations_and_Politics_across_all_proportion",
                    state_self: "Government_Operations_And_Politics_state_self_proportion",
                    state_national: "Government_Operations_And_Politics_state_national_proportion"
                },
                {
                    display: "Health and Healthcare",
                    member_self: "Health_and_Healthcare_self_proportion",
                    member_across_all: "Health_and_Healthcare_across_all_proportion",
                    state_self: "Health_And_Healthcare_state_self_proportion",
                    state_national: "Health_And_Healthcare_state_national_proportion"
                },
                {
                    display: "Immigration and Civil Rights",
                    member_self: "Immigration_and_Civil_Rights_self_proportion",
                    member_across_all: "Immigration_and_Civil_Rights_across_all_proportion",
                    state_self: "Immigration_And_Civil_Rights_state_self_proportion",
                    state_national: "Immigration_And_Civil_Rights_state_national_proportion"
                },
                {
                    display: "National Security and International Affairs",
                    member_self: "National_Security_and_International_Affairs_self_proportion",
                    member_across_all: "National_Security_and_International_Affairs_across_all_proportion",
                    state_self: "National_Security_And_International_Affairs_state_self_proportion",
                    state_national: "National_Security_And_International_Affairs_state_national_proportion"
                },
                {
                    display: "Science, Technology and Communications",
                    member_self: "Science__Technology__and_Communications_self_proportion", // Note double underscores
                    member_across_all: "Science__Technology__and_Communications_across_all_proportion",
                    state_self: "Science_Technology_And_Communications_state_self_proportion",
                    state_national: "Science_Technology_And_Communications_state_national_proportion" // Corrected mapping
                },
                {
                    display: "Transportation and Infrastructure",
                    member_self: "Transportation_and_Infrastructure_self_proportion",
                    member_across_all: "Transportation_and_Infrastructure_across_all_proportion",
                    state_self: "Transportation_And_Infrastructure_state_self_proportion",
                    state_national: "Transportation_And_Infrastructure_state_national_proportion"
                }
            ];

            // Set up dimensions and margins
            const margin = {top: 70, right: 100, bottom: 70, left: 100},
                width = Math.min(550, window.innerWidth - 10) - margin.left - margin.right,
                height = Math.min(width, window.innerHeight - margin.top - margin.bottom - 20);
            
            const radarChartOptions = {
                w: width,
                h: height,
                margin: margin,
                levels: 5,
                roundStrokes: true,
                color: d3.scaleOrdinal(d3.schemeCategory10),
                transitionDuration: 750
            };
            
            let radarChartInstance = null;
            let currentProportionType = 'self'; // Default proportion type
            
            // Function to transform member data into radar chart format
            function getRadarDatasets(member, proportionType) {
                const datasets = [[], []]; // datasets[0] = Congress Member, datasets[1] = State Proportion

                policyAreas.forEach(policy => {
                    // Congress Member's Proportion
                    const memberField = proportionType === 'self' ? policy.member_self : policy.member_across_all;
                    let memberValue = parseFloat(member[memberField]) || 0;
                    datasets[0].push({ axis: policy.display, value: memberValue });

                    // State Proportion
                    const stateField = proportionType === 'self' ? policy.state_self : policy.state_national;
                    let stateValue = parseFloat(member[stateField]) || 0;
                    datasets[1].push({ axis: policy.display, value: stateValue });
                });

                // Assign index properties to each dataset for color mapping
                datasets[0].index = 0; // Congress Member
                datasets[1].index = 1; // State Proportion

                // Apply chamber-specific scaling factor for "Across All Proportion"
                if (proportionType === 'across_all') {
                    const scalingFactor = SCALING_FACTORS[member.chamber] || 1; // Default to 1 if chamber not found
                    datasets[0] = datasets[0].map(d => ({ axis: d.axis, value: d.value * scalingFactor }));
                    // Reassign the index property after scaling to preserve color mapping
                    datasets[0].index = 0;
                }

                return datasets;
            }
            
            // Load CSV data using D3 v6 Promise-based approach
            d3.csv("congress_members_with_proportions.csv").then(function(data) {
                // Store data globally
                window.congressMembersData = data;

                // Optionally, hide or remove the dropdown since selection is via the map
                d3.select("#controls").style("display", "none");

                // Function to update the radar chart and member details
                function updateChart(bioguideId) {
                    const member = window.congressMembersData.find(d => d.bioguide_id === bioguideId);
                    if (!member) {
                        console.error(`Member with bioguide_id "${bioguideId}" not found.`);
                        return;
                    }
                    
                    const radarDatasets = getRadarDatasets(member, currentProportionType);
                    
                    if (!radarChartInstance) {
                        // Initialize the radar chart if not already done
                        RadarChart(".radarChart", radarDatasets, radarChartOptions);
                        radarChartInstance = true;
                    } else {
                        // Update the radar chart with new data
                        RadarChart.update(radarDatasets);
                    }
                    
                    // Update member details
                    const details = d3.select("#member-details");
                    details.html(
                        `<strong>Name:</strong> ${member.name}<br/>
                        <strong>State:</strong> ${member.state}<br/>
                        ${
                            member.chamber === "House of Representatives"
                            ? `<strong>District:</strong> ${parseInt(member.district, 10)}<br>`
                            : ""
                    }
                        <strong>Chamber:</strong> ${member.chamber}`
                    );
                    
                    // Update the legend
                    updateLegend();
                }
                
                // Expose the updateChart function globally
                window.updateRadarChart = updateChart;

                // Initialize with the first member (optional)
                if (data.length > 0) {
                    const initialBioguideId = data[0].bioguide_id;
                    updateChart(initialBioguideId);
                }
                
                // Handle proportion type toggle
                d3.selectAll('input[name="proportion-toggle"]').on("change", function() {
                    const selectedType = d3.select('input[name="proportion-toggle"]:checked').node().value;
                    currentProportionType = selectedType;
                    
                    // Update the currently selected member's radar chart
                    // Assuming you have a variable to store the currently selected bioguide_id
                    if (window.currentSelectedBioguideId) {
                        updateChart(window.currentSelectedBioguideId);
                    }
                });
            }).catch(function(error){
                console.error("Error loading CSV data:", error);
            });

            // Function to create/update the legend
            function updateLegend() {
                const legendData = [
                    { name: "Congress Member", color: radarChartOptions.color(0) },
                    { name: "State Proportion", color: radarChartOptions.color(1) }
                ];
                
                const legendSvg = d3.select("#legend-container").select("svg");
                legendSvg.selectAll("*").remove(); // Clear existing legend
                
                const legend = legendSvg.selectAll(".legend")
                    .data(legendData)
                    .enter()
                    .append("g")
                    .attr("class", "legend")
                    .attr("transform", (d, i) => `translate(10, ${i * 20 + 10})`);
                
                legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", d => d.color)
                    .style("stroke", "black");
                
                legend.append("text")
                    .attr("x", 25)
                    .attr("y", 14)
                    .text(d => d.name);
            }
        }
    }




        ///////////////////////////////////////////////////////////
        ///////// Dan Test Charts 2/////////////////////
        ///////////////////////////////////////////////////////////


        // Function to initialize the D3 chart in the Ideology tab
        function initializeIdeologyChart() {
            // Check if the chart has already been initialized to avoid re-initializing
            if (!initializeIdeologyChart.initialized) {
                initializeIdeologyChart.initialized = true; // Set a flag to prevent re-initialization

                /////// D3 chart code /////////

                // Set dimensions and margins
                const container = d3.select("#ideology-bar-chart").node().parentNode;
                const containerWidth = container.getBoundingClientRect().width;
                const containerHeight = 600;

                const margin = { top: 50, right: 30, bottom: 150, left: 60 },
                      width = containerWidth - margin.left - margin.right,
                      height = containerHeight - margin.top - margin.bottom;

                // Append SVG object to the container
                const svg = d3.select("#ideology-bar-chart")
                    .attr("width", containerWidth)
                    .attr("height", containerHeight)
                    .html('') // Clear any existing content
                  .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Create tooltip
                const tooltip = d3.select(".tooltip");

                // Variables to store data and topics
                let allData = [];
                let topicsList = [];

                // Define a color scale
                const color = d3.scaleOrdinal()
                    .range(d3.schemeCategory10);

                // Load the CSV data
                d3.csv("combined_data.csv").then(data => {
                    
                    // Process the data
                    allData = processData(data);
                    
                    // Extract unique topics
                    const topics = Array.from(new Set(allData.flatMap(d => d.topics)));
                    topicsList = topics; // Store for potential future use

                    // Populate the dropdown
                    populateDropdown(topics);

                    // Initialize scales and axes
                    initializeChart();

                    // Event listener for dropdown
                    d3.select("#topic-select").on("change", function() {
                        const selectedTopic = this.value;
                        if (selectedTopic === "") {
                            updateChart([]);
                        } else {
                            const filteredData = getDataForTopic(allData, selectedTopic);
                            updateChart(filteredData);
                        }
                    });
                }).catch(error => {
                    console.error("Error loading the CSV data:", error);
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .attr("fill", "red")
                        .text("Failed to load data.");
                });

                /**
                 * Processes the raw CSV data to aggregate counts per state and topic.
                 * @param {Array} data - The raw CSV data.
                 * @returns {Array} - Processed data with state and topics.
                 */
                function processData(data) {
                    return data.map(d => {
                        // Parse the assigned_label string into an array
                        const topics = JSON.parse(d.assigned_label.replace(/'/g, '"'));
                        return {
                            state: d.state, // Ensure your CSV has a 'state' column
                            topics: topics
                        };
                    });
                }

                /**
                 * Populates the topic selection dropdown.
                 * @param {Array} topics - The list of unique topics.
                 */
                function populateDropdown(topics) {
                    const dropdown = d3.select("#topic-select");
                    dropdown.selectAll('option').remove(); // Clear existing options
                    dropdown.append("option")
                        .attr("value", "")
                        .text("--Select a Topic--");
                    topics.forEach(topic => {
                        dropdown.append("option")
                            .attr("value", topic)
                            .text(capitalize(topic));
                    });
                }

                /**
                 * Initializes the chart by setting up scales, axes, and initial empty bars.
                 */
                function initializeChart() {
                    // X scale: States (categorical)
                    svg.append("g")
                        .attr("class", "x-axis")
                        .attr("transform", `translate(0, ${height})`);

                    // Y scale: Counts (linear)
                    svg.append("g")
                        .attr("class", "y-axis");

                    // Axis labels
                    // Y axis label
                    svg.append("text")
                        .attr("class", "axis-label")
                        .attr("transform", "rotate(-90)")
                        .attr("x", -height / 2)
                        .attr("y", -margin.left + 15)
                        .attr("text-anchor", "middle")
                        .attr("fill", "black")
                        .text("Count");

                    // X axis label
                    svg.append("text")
                        .attr("class", "axis-label")
                        .attr("x", width / 2)
                        .attr("y", height + margin.bottom - 40)
                        .attr("text-anchor", "middle")
                        .attr("fill", "black")
                        .text("State");
                }

                /**
                 * Retrieves the aggregated data for a specific topic.
                 * @param {Array} data - The processed data.
                 * @param {string} topic - The selected topic.
                 * @returns {Array} - Aggregated data for the topic.
                 */
                function getDataForTopic(data, topic) {
                    const counts = d3.rollups(
                        data,
                        v => v.filter(d => d.topics.includes(topic)).length,
                        d => d.state
                    );

                    // Convert to array of objects
                    return counts.map(([state, count]) => ({ state, count }));
                }

                /**
                 * Updates the bar chart with new data, applying smooth transitions.
                 * @param {Array} data - The aggregated data to display.
                 */
                function updateChart(data) {
                    if (data.length === 0) {
                        // If no topic is selected, clear the chart
                        svg.selectAll(".bar").remove();
                        svg.select(".y-axis").transition().duration(750).call(d3.axisLeft(d3.scaleLinear().range([height, 0])));
                        svg.select(".x-axis").transition().duration(750).call(d3.axisBottom(d3.scaleBand().range([0, width]).padding(0.2)));
                        return;
                    }

                    // Sort data descending to order bars from highest to lowest
                    data.sort((a, b) => b.count - a.count);

                    // Update the X scale domain based on sorted data
                    const x = d3.scaleBand()
                        .domain(data.map(d => d.state))
                        .range([0, width])
                        .padding(0.2);

                    // Update the Y scale domain based on the new data
                    const y = d3.scaleLinear()
                        .domain([0, d3.max(data, d => d.count) + 5])
                        .range([height, 0]);

                    // Update the X axis with transition
                    svg.select(".x-axis")
                        .transition()
                        .duration(750)
                        .call(d3.axisBottom(x))
                      .selectAll("text")
                        .attr("transform", "rotate(-45)")
                        .style("text-anchor", "end");

                    // Update the Y axis with transition
                    svg.select(".y-axis")
                        .transition()
                        .duration(750)
                        .call(d3.axisLeft(y));

                    // Bind the new data to the bars
                    const bars = svg.selectAll(".bar")
                        .data(data, d => d.state);

                    // Handle entering bars
                    bars.enter()
                        .append("rect")
                        .attr("class", "bar")
                        .attr("x", d => x(d.state))
                        .attr("width", x.bandwidth())
                        .attr("y", y(0)) // Start from y=0
                        .attr("height", 0) // Start with height=0
                        .attr("fill", d => d3.schemeCategory10[d.state.charCodeAt(0) % 10]) // Assign color
                        .on("mouseover", function(event, d) {
                            d3.select(this).attr("fill", "#ff9933");
                            tooltip.style("opacity", 1)
                                   .html(`<strong>${d.state}</strong><br>Count: ${d.count}`)
                                   .style("left", (event.pageX + 10) + "px")
                                   .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mousemove", function(event) {
                            tooltip.style("left", (event.pageX + 10) + "px")
                                   .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function(event, d) {
                            d3.select(this).attr("fill", d3.schemeCategory10[d.state.charCodeAt(0) % 10]);
                            tooltip.style("opacity", 0);
                        })
                        .transition()
                        .duration(750)
                            .attr("y", d => y(d.count))
                            .attr("height", d => height - y(d.count));

                    // Update existing bars
                    bars.transition()
                        .duration(750)
                        .attr("x", d => x(d.state))
                        .attr("width", x.bandwidth())
                        .attr("y", d => y(d.count))
                        .attr("height", d => height - y(d.count))
                        .attr("fill", d => d3.schemeCategory10[d.state.charCodeAt(0) % 10]);

                    // Handle exiting bars
                    bars.exit()
                        .transition()
                        .duration(750)
                            .attr("y", y(0))
                            .attr("height", 0)
                            .remove();
                }

                /**
                 * Capitalizes the first letter of a string.
                 * @param {string} str - The input string.
                 * @returns {string} - The capitalized string.
                 */
                function capitalize(str) {
                    return str.charAt(0).toUpperCase() + str.slice(1);
                }
            }
        }
    </script>
</body>
</html>